#!/bin/bash
#FILE=${1:-./Context/conjuration_log.json}#

#watch -n 1 bash -c "
#  clear
#  echo 'ðŸ“œ Make a plan for your next conjuration'
#  echo 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€'
#  jq -r '
#    paths(scalars) as \$p |
#    \"\(\$p | join(\" â†’ \")):\t\(. | getpath(\$p))\"#
#	' \"$FILE\" | sed 's/^/â€¢ /' | less -R
#"

#!/bin/bash
FILE=${1:-./Context/conjuration_log.json}
spinner="/|\\-"
i=0
BASELINE="/tmp/.jsonwatch_baseline.txt"

# Store initial flat snapshot
jq -r '
  paths(scalars) as $p |
  "\($p | join(" â†’ ")):\t\(getpath($p))"
' "$FILE" > "$BASELINE"

while true; do
 clear
  printf "ðŸ“œ Make a plan for your next conjuration \033[2m[%c]\033[0m\n" "${spinner:i++%${#spinner}:1}"
  echo 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€'
  
  # Flatten current state
  TMP_CURR=$(mktemp)
  jq -r '
    paths(scalars) as $p |
    "\($p | join(" â†’ ")):\t\(getpath($p))"
  ' "$FILE" > "$TMP_CURR"

  # Compare against baseline and color if changed
  while IFS= read -r line; do
    key=${line%%:*}
    val=${line#*:}
    orig_val=$(grep "^$key:" "$BASELINE" | cut -f2-)

    if [[ "$val" != "$orig_val" ]]; then
      # Yellow for changed entries
      printf "â€¢ %s:\t\033[33m%s\033[0m\n" "$key" "$val"
    else
      printf "â€¢ %s:\t%s\n" "$key" "$val"
    fi
  done < "$TMP_CURR"

  rm "$TMP_CURR"
  sleep 1
done
